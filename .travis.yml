sudo: required
language: node_js

env:
  global:
    AWS_ACCESS_KEY_ID: AKIAIPTBDX3T4GLIVGZA
    AWS_SECRET_ACCESS_KEY: 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
    ECS_CLUSTER: pruebita-6
    AWS_REGION: ue-east-2

services:
  - docker

node_js:
  - "8.11.3"

script:
  - npm run test


after_success:
  - docker --version  # document the version travis is using
  - pip install --user awscli # install aws cli w/o sudo
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
  - eval $(aws ecr get-login --region us-east-1) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
  - docker build -t express-hello .
  - docker tag express-hello:latest 412237081001.dkr.ecr.us-east-2.amazonaws.com/express-hello:$TRAVIS_COMMIT
  - docker tag express-hello:latest 412237081001.dkr.ecr.us-east-2.amazonaws.com/express-hello:latest
  - docker push 412237081001.dkr.ecr.us-east-2.amazonaws.com/express-hello:$TRAVIS_COMMIT
  - docker push 412237081001.dkr.ecr.us-east-2.amazonaws.com/express-hello:latest
  - export HELLO_IMAGE_VERSION=$TRAVIS_COMMIT
  - node run generateDeployFile
  - sudo curl -o ./ecs-cli https://s3.amazonaws.com/amazon-ecs-cli/ecs-cli-linux-amd64-latest
  - chmod +x ./ecs-cli
  - ./ecs-cli compose down
  - ./ecs-cli compose up
